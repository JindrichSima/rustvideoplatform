<!DOCTYPE html>
<html>

<head>
    {% include "component-dependencies.html" %}

    <title>Upload</title>

    <meta property="og:title" content="{{ config.instancename }} Upload" />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://{{ common_headers.host }}/upload" />
</head>

<body>
    {{ sidebar }}
    {% include "component-navbar.html" %}
    <div class="row maincontentrow g-3 py-2 ps-2" style="max-width: 99%;">
        <div class="col-12 col-sm-12 col-md-12 col-lg-12">
            <div class="card py-3 px-3 text-white" style="min-height: 80vh;">
                <h3 class="my-2 mx-3">Upload</h3>
                <hr>
                <form id="uploadForm" action="/hx/upload" method="post" enctype="multipart/form-data" hx-post="/hx/upload"
                    hx-trigger="submit" hx-progress="#progress-bar" hx-target="#response" hx-swap="innerHTML">
                    <input type="file" name="file" />
                    <input type="submit" value="Upload" />
                </form>
                <div id="progress-wrapper" style="width: 100%; background-color: #ccc;">
                    <div id="progress-bar" style="width: 0%; height: 20px; background-color: green;"></div>
                </div>
                <p id="upload-speed"></p>
                <div id="response"></div>

                <script>
                    let startTime, fileSize;

                    document.getElementById('uploadForm').addEventListener('submit', function (e) {
                        const fileInput = document.querySelector('input[name="file"]');
                        fileSize = fileInput.files[0].size;
                        startTime = Date.now();
                        const xhr = new XMLHttpRequest();

                        xhr.upload.onprogress = function (event) {
                            if (event.lengthComputable) {
                                let percentComplete = (event.loaded / event.total) * 100;
                                document.getElementById('progress-bar').style.width = percentComplete + '%';

                                // Calculate upload speed in Mbps
                                const currentTime = Date.now();
                                const duration = (currentTime - startTime) / 1000; // in seconds
                                const speed = (event.loaded / (1024 * 1024)) / duration; // in MBps
                                document.getElementById('upload-speed').textContent = `Upload speed: ${speed.toFixed(2)} MBps`;
                            }
                        };

                        xhr.open('POST', '/hx/upload', true);
                        const formData = new FormData(document.getElementById('uploadForm'));
                        xhr.send(formData);

                        xhr.onload = function () {
                            if (xhr.status === 200) {
                                document.getElementById('response').innerHTML = xhr.responseText;
                            } else {
                                document.getElementById('response').innerHTML = 'Upload failed!';
                            }
                        };

                        e.preventDefault();
                    });
                </script>
            </div>
        </div>
    </div>
</body>

</html>